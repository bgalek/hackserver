package pl.allegro.experiments.chi.chiserver.domain.statistics

import com.google.gson.Gson
import com.google.gson.GsonBuilder
import pl.allegro.experiments.chi.chiserver.domain.statistics.bayes.BayesianExperimentStatistics
import spock.lang.Specification

class BayesianVerticalEqualizerSpec extends Specification {

    def "should build Vertical Equalizer from raw Bayesian stats"(){
      when:
      def equalizer = new BayesianVerticalEqualizer(sampleStats())

      then:
      equalizer.bars.size() == 2
      def bar = equalizer.bars.find{it.variantName.get() == "test-a" }

      bar.improvingProbabilities[0] + bar.worseningProbabilities[0] == 1.0
      bar.improvingProbabilities == [0.7969, 0.5866, 0.3506, 0.1636, 0.0577]
      bar.worseningProbabilities == [0.2031, 0.0735, 0.0191, 0.0035, 0.0006]
    }

    static BayesianExperimentStatistics sampleStats() {
        def sampleJson =
        """
{
    "experimentId" : "ux-404-new",
    "toDate" : "2018-05-13",
    "device" : "desktop",
    "variantBayesianStatistics" : [ 
        {
            "variantName" : "test-a",
            "outliersLeft": 10,
            "outliersRight": 122,
            "samples" : {
                "values" : [ 
                    -0.1, 
                    -0.099, 
                    -0.098, 
                    -0.097, 
                    -0.096, 
                    -0.095, 
                    -0.094, 
                    -0.093, 
                    -0.092, 
                    -0.091, 
                    -0.09, 
                    -0.089, 
                    -0.088, 
                    -0.087, 
                    -0.086, 
                    -0.085, 
                    -0.084, 
                    -0.083, 
                    -0.082, 
                    -0.081, 
                    -0.08, 
                    -0.079, 
                    -0.078, 
                    -0.077, 
                    -0.076, 
                    -0.075, 
                    -0.074, 
                    -0.073, 
                    -0.072, 
                    -0.071, 
                    -0.07, 
                    -0.069, 
                    -0.068, 
                    -0.067, 
                    -0.066, 
                    -0.065, 
                    -0.064, 
                    -0.063, 
                    -0.062, 
                    -0.061, 
                    -0.06, 
                    -0.059, 
                    -0.058, 
                    -0.057, 
                    -0.056, 
                    -0.055, 
                    -0.054, 
                    -0.053, 
                    -0.052, 
                    -0.051, 
                    -0.05, 
                    -0.049, 
                    -0.048, 
                    -0.047, 
                    -0.046, 
                    -0.045, 
                    -0.044, 
                    -0.043, 
                    -0.042, 
                    -0.041, 
                    -0.04, 
                    -0.039, 
                    -0.038, 
                    -0.037, 
                    -0.036, 
                    -0.035, 
                    -0.034, 
                    -0.033, 
                    -0.032, 
                    -0.031, 
                    -0.03, 
                    -0.029, 
                    -0.028, 
                    -0.027, 
                    -0.026, 
                    -0.025, 
                    -0.024, 
                    -0.023, 
                    -0.022, 
                    -0.021, 
                    -0.02, 
                    -0.019, 
                    -0.018, 
                    -0.017, 
                    -0.016, 
                    -0.015, 
                    -0.014, 
                    -0.013, 
                    -0.012, 
                    -0.011, 
                    -0.01, 
                    -0.009, 
                    -0.008, 
                    -0.007, 
                    -0.006, 
                    -0.005, 
                    -0.004, 
                    -0.003, 
                    -0.002, 
                    -0.001, 
                    0.001, 
                    0.002, 
                    0.003, 
                    0.004, 
                    0.005, 
                    0.006, 
                    0.007, 
                    0.008, 
                    0.009, 
                    0.01, 
                    0.011, 
                    0.012, 
                    0.013, 
                    0.014, 
                    0.015, 
                    0.016, 
                    0.017, 
                    0.018, 
                    0.019, 
                    0.02, 
                    0.021, 
                    0.022, 
                    0.023, 
                    0.024, 
                    0.025, 
                    0.026, 
                    0.027, 
                    0.028, 
                    0.029, 
                    0.03, 
                    0.031, 
                    0.032, 
                    0.033, 
                    0.034, 
                    0.035, 
                    0.036, 
                    0.037, 
                    0.038, 
                    0.039, 
                    0.04, 
                    0.041, 
                    0.042, 
                    0.043, 
                    0.044, 
                    0.045, 
                    0.046, 
                    0.047, 
                    0.048, 
                    0.049, 
                    0.05, 
                    0.051, 
                    0.052, 
                    0.053, 
                    0.054, 
                    0.055, 
                    0.056, 
                    0.057, 
                    0.058, 
                    0.059, 
                    0.06, 
                    0.061, 
                    0.062, 
                    0.063, 
                    0.064, 
                    0.065, 
                    0.066, 
                    0.067, 
                    0.068, 
                    0.069, 
                    0.07, 
                    0.071, 
                    0.072, 
                    0.073, 
                    0.074, 
                    0.075, 
                    0.076, 
                    0.077, 
                    0.078, 
                    0.079, 
                    0.08, 
                    0.081, 
                    0.082, 
                    0.083, 
                    0.084, 
                    0.085, 
                    0.086, 
                    0.087, 
                    0.088, 
                    0.089, 
                    0.09, 
                    0.091, 
                    0.092, 
                    0.093, 
                    0.094, 
                    0.095, 
                    0.096, 
                    0.097, 
                    0.098, 
                    0.099, 
                    0.1
                ],
                "counts" : [ 
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    1,
                    0,
                    0,
                    0,
                    0,
                    1,
                    2,
                    1,
                    1,
                    3,
                    5,
                    5,
                    10,
                    7,
                    16,
                    16,
                    8,
                    16,
                    19,
                    28,
                    13,
                    43,
                    41,
                    39,
                    67,
                    64,
                    95,
                    111,
                    122,
                    137,
                    158,
                    190,
                    190,
                    239,
                    254,
                    325,
                    346,
                    395,
                    425,
                    483,
                    557,
                    650,
                    705,
                    740,
                    818,
                    912,
                    967,
                    1133,
                    1177,
                    1254,
                    1341,
                    1364,
                    1459,
                    1673,
                    1704,
                    1805,
                    1824,
                    1907,
                    2129,
                    2125,
                    2085,
                    2241,
                    2199,
                    2345,
                    2393,
                    2415,
                    2395,
                    2429,
                    2399,
                    2417,
                    2472,
                    2318,
                    2281,
                    2253,
                    2253,
                    2209,
                    2104,
                    2058,
                    2052,
                    1961,
                    1843,
                    1841,
                    1660,
                    1542,
                    1453,
                    1474,
                    1313,
                    1258,
                    1127,
                    1082,
                    962,
                    964,
                    872,
                    779,
                    774,
                    586,
                    576,
                    538,
                    485,
                    466,
                    373,
                    368,
                    290,
                    262,
                    244,
                    176,
                    200,
                    159,
                    132,
                    114,
                    109,
                    89,
                    80,
                    53,
                    49,
                    53,
                    39,
                    37,
                    31,
                    24,
                    18,
                    18,
                    13,
                    8,
                    16,
                    5,
                    11,
                    11,
                    7,
                    4,
                    4,
                    3,
                    3,
                    0,
                    2,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    1,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0]        
            }
        }, 
        {
            "variantName" : "test-b",
            "samples" : {
                "values" : [ 
                    -0.1, 
                    -0.099, 
                    -0.098, 
                    -0.097, 
                    -0.096, 
                    -0.095, 
                    -0.094, 
                    -0.093, 
                    -0.092, 
                    -0.091, 
                    -0.09, 
                    -0.089, 
                    -0.088, 
                    -0.087, 
                    -0.086, 
                    -0.085, 
                    -0.084, 
                    -0.083, 
                    -0.082, 
                    -0.081, 
                    -0.08, 
                    -0.079, 
                    -0.078, 
                    -0.077, 
                    -0.076, 
                    -0.075, 
                    -0.074, 
                    -0.073, 
                    -0.072, 
                    -0.071, 
                    -0.07, 
                    -0.069, 
                    -0.068, 
                    -0.067, 
                    -0.066, 
                    -0.065, 
                    -0.064, 
                    -0.063, 
                    -0.062, 
                    -0.061, 
                    -0.06, 
                    -0.059, 
                    -0.058, 
                    -0.057, 
                    -0.056, 
                    -0.055, 
                    -0.054, 
                    -0.053, 
                    -0.052, 
                    -0.051, 
                    -0.05, 
                    -0.049, 
                    -0.048, 
                    -0.047, 
                    -0.046, 
                    -0.045, 
                    -0.044, 
                    -0.043, 
                    -0.042, 
                    -0.041, 
                    -0.04, 
                    -0.039, 
                    -0.038, 
                    -0.037, 
                    -0.036, 
                    -0.035, 
                    -0.034, 
                    -0.033, 
                    -0.032, 
                    -0.031, 
                    -0.03, 
                    -0.029, 
                    -0.028, 
                    -0.027, 
                    -0.026, 
                    -0.025, 
                    -0.024, 
                    -0.023, 
                    -0.022, 
                    -0.021, 
                    -0.02, 
                    -0.019, 
                    -0.018, 
                    -0.017, 
                    -0.016, 
                    -0.015, 
                    -0.014, 
                    -0.013, 
                    -0.012, 
                    -0.011, 
                    -0.01, 
                    -0.009, 
                    -0.008, 
                    -0.007, 
                    -0.006, 
                    -0.005, 
                    -0.004, 
                    -0.003, 
                    -0.002, 
                    -0.001, 
                    0.001, 
                    0.002, 
                    0.003, 
                    0.004, 
                    0.005, 
                    0.006, 
                    0.007, 
                    0.008, 
                    0.009, 
                    0.01, 
                    0.011, 
                    0.012, 
                    0.013, 
                    0.014, 
                    0.015, 
                    0.016, 
                    0.017, 
                    0.018, 
                    0.019, 
                    0.02, 
                    0.021, 
                    0.022, 
                    0.023, 
                    0.024, 
                    0.025, 
                    0.026, 
                    0.027, 
                    0.028, 
                    0.029, 
                    0.03, 
                    0.031, 
                    0.032, 
                    0.033, 
                    0.034, 
                    0.035, 
                    0.036, 
                    0.037, 
                    0.038, 
                    0.039, 
                    0.04, 
                    0.041, 
                    0.042, 
                    0.043, 
                    0.044, 
                    0.045, 
                    0.046, 
                    0.047, 
                    0.048, 
                    0.049, 
                    0.05, 
                    0.051, 
                    0.052, 
                    0.053, 
                    0.054, 
                    0.055, 
                    0.056, 
                    0.057, 
                    0.058, 
                    0.059, 
                    0.06, 
                    0.061, 
                    0.062, 
                    0.063, 
                    0.064, 
                    0.065, 
                    0.066, 
                    0.067, 
                    0.068, 
                    0.069, 
                    0.07, 
                    0.071, 
                    0.072, 
                    0.073, 
                    0.074, 
                    0.075, 
                    0.076, 
                    0.077, 
                    0.078, 
                    0.079, 
                    0.08, 
                    0.081, 
                    0.082, 
                    0.083, 
                    0.084, 
                    0.085, 
                    0.086, 
                    0.087, 
                    0.088, 
                    0.089, 
                    0.09, 
                    0.091, 
                    0.092, 
                    0.093, 
                    0.094, 
                    0.095, 
                    0.096, 
                    0.097, 
                    0.098, 
                    0.099, 
                    0.1
                ],
                "counts" : [ 
                    0, 
                    0, 
                    0, 
                    0, 
                    0, 
                    0, 
                    0, 
                    0, 
                    0, 
                    0, 
                    0, 
                    0, 
                    0, 
                    0, 
                    0, 
                    0, 
                    0, 
                    0, 
                    0, 
                    0, 
                    0, 
                    0, 
                    0, 
                    0, 
                    0, 
                    0, 
                    0, 
                    2, 
                    1, 
                    1, 
                    0, 
                    0, 
                    1, 
                    3, 
                    2, 
                    1, 
                    1, 
                    3, 
                    3, 
                    4, 
                    4, 
                    6, 
                    8, 
                    6, 
                    15, 
                    9, 
                    19, 
                    29, 
                    27, 
                    37, 
                    35, 
                    48, 
                    48, 
                    75, 
                    68, 
                    87, 
                    108, 
                    121, 
                    133, 
                    149, 
                    189, 
                    180, 
                    211, 
                    291, 
                    287, 
                    328, 
                    333, 
                    425, 
                    455, 
                    460, 
                    530, 
                    591, 
                    651, 
                    732, 
                    792, 
                    884, 
                    961, 
                    984, 
                    1075, 
                    1170, 
                    1198, 
                    1328, 
                    1405, 
                    1474, 
                    1585, 
                    1587, 
                    1760, 
                    1793, 
                    1801, 
                    1925, 
                    1998, 
                    1982, 
                    2179, 
                    2111, 
                    2174, 
                    2185, 
                    2219, 
                    2210, 
                    2243, 
                    2273, 
                    2275, 
                    2249, 
                    2201, 
                    2199, 
                    2150, 
                    2099, 
                    2086, 
                    2038, 
                    2067, 
                    1957, 
                    1952, 
                    1862, 
                    1769, 
                    1643, 
                    1640, 
                    1462, 
                    1474, 
                    1416, 
                    1266, 
                    1166, 
                    1167, 
                    1060, 
                    976, 
                    948, 
                    887, 
                    813, 
                    699, 
                    682, 
                    578, 
                    593, 
                    483, 
                    466, 
                    434, 
                    379, 
                    331, 
                    317, 
                    269, 
                    240, 
                    223, 
                    207, 
                    155, 
                    135, 
                    125, 
                    100, 
                    115, 
                    100, 
                    77, 
                    60, 
                    56, 
                    49, 
                    53, 
                    36, 
                    33, 
                    33, 
                    20, 
                    21, 
                    17, 
                    15, 
                    11, 
                    6, 
                    7, 
                    9, 
                    9, 
                    5, 
                    2, 
                    4, 
                    3, 
                    1, 
                    2, 
                    1, 
                    1, 
                    1, 
                    1, 
                    0, 
                    1, 
                    0, 
                    0, 
                    0, 
                    0, 
                    0, 
                    0, 
                    0, 
                    0, 
                    0, 
                    0, 
                    0, 
                    0, 
                    0, 
                    0, 
                    0, 
                    0, 
                    0, 
                    0, 
                    0, 
                    0, 
                    0, 
                    0, 
                    0, 
                    0, 
                    0
                ]
            }
        }
    ]
}
"""
        Gson gson = new GsonBuilder().create()
        gson.fromJson(sampleJson, BayesianExperimentStatistics)
    }
}
