---
name: chi-server
group: pl.allegro.experiments.chi

version_scheme:
  type: external

build:
  - command: ./gradlew distZip

package: "build/distributions/{{ name }}-{{ version }}.zip"

publish:
  - artifactory:
      host: artifactory.allegrogroup.com
      user: "{{ TYCHO_ENV['bamboo_artifactory_username'] }}"
      pass: "{{ TYCHO_ENV['bamboo_artifactory_password'] }}"

vars:
  health_check: &HEALTH_CHECK
    protocol: "HTTP"
    path: "/status/info"
    gracePeriodSeconds: 60
    intervalSeconds: 5
    portIndex: 0
    timeoutSeconds: 10
    maxConsecutiveFailures: 3

  timeouts: &TIMEOUTS
    get_instances_urls_timeout: 180

  labels: &LABELS
    default-monitoring: tag

  test_resources: &TEST_RESOURCES
    cpus: 0.2
    mem: 1024
    env_vars:
      JAVA_OPTS: "-Xmx700m -Xms700m -XX:MetaspaceSize=100m
                  -Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.port=$PORT1 -Dcom.sun.management.jmxremote.local.only=false
                  -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false -Djava.rmi.server.hostname=$MESOS_HOSTNAME"

  prod_resources: &PROD_RESOURCES
    cpus: 1
    mem: 2048
    env_vars:
      JAVA_OPTS: "-Xmx900m -Xms900m -XX:MetaspaceSize=100m"

deploy:
  dev:
    - lbaas:
        vip: "chi-server_chi-dev.allegrogroup.com_80"
    - marathon:
        jvmVersion: "10"
        command: "{{ name }}-{{ version }}/bin/{{ name }} -e dev -p $PORT0"
        port_count: 2
        url: http://marathon-dev.qxlint/
        user: _tech_newservice
        pass: "{{ TYCHO_ENV['bamboo_marathon_dev_password'] }}"
        labels:
          consul: "{{ name }}"
          << : *LABELS
        instances: 1
        << : *TEST_RESOURCES
        health_check:
          << : *HEALTH_CHECK
        timeouts:
          << : *TIMEOUTS
        constraints:
          - ["dc", "LIKE", "dc4"]

  test:
    - lbaas:
        vip: "chi-server_chi-test.allegrogroup.com_80"
    - marathon:
        jvmVersion: "10"
        command: "{{ name }}-{{ version }}/bin/{{ name }} -e test -p $PORT0"
        port_count: 2
        url: http://marathon-test.qxlint/
        user: marathon
        pass: "{{ TYCHO_ENV['bamboo_marathon_test_password'] }}"
        labels:
          consul: "{{ name }}"
          << : *LABELS
        instances: 1
        << : *TEST_RESOURCES
        health_check:
          << : *HEALTH_CHECK
        timeouts:
          << : *TIMEOUTS
        constraints:
          - ["dc", "LIKE", "dc4"]

  prod:
    - lbaas:
        vip: "chi-server_chi.allegrogroup.com_80"
    - marathon:
        jvmVersion: "10"
        command: "{{ name }}-{{ version }}/bin/{{ name }} -e prod -p $PORT0"
        url: http://marathon.qxlint/
        user: pd_prod
        pass: "{{ TYCHO_ENV['bamboo_marathon_prod_password'] }}"
        labels:
          consul: "{{ name }}"
          << : *LABELS
        instances: 4
        << : *PROD_RESOURCES
        health_check:
          << : *HEALTH_CHECK
        timeouts:
          << : *TIMEOUTS
